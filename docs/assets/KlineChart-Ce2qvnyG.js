import{r as w,d as X,j as h}from"./react-vendor-WmtqSjM5.js";import{h as Z,q as dt,W as ft,R as gt}from"./charts-CziYGgDh.js";import{f as ht,l as pt,c as mt}from"./index-CD2VFLYC.js";import{D as yt,a as St,b as wt,c as xt}from"./mui-dialog-Cu9Rnm4R.js";import{a as z,T as nt,b as Dt}from"./mui-base-CpFAOAUj.js";import{b as bt}from"./mui-form-W2H_mmwe.js";import{S as $t,T as Tt,b as tt}from"./mui-selection-DsJrQxk2.js";import{E as kt}from"./mui-material-BT1LjSYG.js";import"./vendor-DIZrNOFg.js";import"./mui-core-CEgmxtsB.js";import"./mui-table-BUJ9UhL6.js";import"./mui-interactive-Dwvn81AS.js";import"./mui-icons-ba46zHnM.js";import"./mui-menu-DWiH6V3b.js";function et(S){switch(S){case"day":return{count:60,days:60};case"week":return{count:26,days:180};case"month":return{count:36,days:1095};default:return{count:60,days:60}}}async function Pt(S,$,I){var s,R;const O=et($),T=O.count,i=O.days;try{let E=S.replace(/^(sh|sz)/,""),c;S.startsWith("sh")?c=!0:S.startsWith("sz")?c=!1:c=!(E.startsWith("00")||E.startsWith("30"));const x=`${c?"1":"0"}.${E}`;let M;$==="day"?M="101":$==="week"?M="102":$==="month"?M="103":M="101";const B=`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${x}&fields1=f1,f2,f3,f4,f5,f6&fields2=f51,f52,f53,f54,f55,f56,f57,f58&klt=${M}&fqt=1&beg=0&end=20500000&lmt=${T}`;console.log(`[K线数据] 请求URL: ${B}`);try{const l=await fetch(B);if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const f=await l.json();console.log("[K线数据] API返回:",f),console.log("[K线数据] json.data:",f.data),console.log("[K线数据] json.data?.klines:",(s=f.data)==null?void 0:s.klines);let C=null;if((R=f.data)!=null&&R.klines&&Array.isArray(f.data.klines)?C=f.data.klines:f.klines&&Array.isArray(f.klines)?C=f.klines:Array.isArray(f.data)?C=f.data:f.rc===0&&f.data&&(console.log("[K线数据] 尝试查找其他数据字段:",Object.keys(f.data)),f.data.data&&Array.isArray(f.data.data)?C=f.data.data:f.data.list&&Array.isArray(f.data.list)&&(C=f.data.list)),!C||C.length===0)throw console.error("[K线数据] 无法找到有效数据，返回结构:",JSON.stringify(f,null,2)),new Error("没有有效数据");console.log(`[K线数据] 找到 ${C.length} 条K线数据`);const q=C.map(k=>{const D=k.split(",");return D.length<6?null:{date:D[0],open:parseFloat(D[1])||0,close:parseFloat(D[2])||0,high:parseFloat(D[3])||0,low:parseFloat(D[4])||0,volume:parseFloat(D[5])||0}}).filter(k=>k!==null&&k.open>0&&k.close>0);if(q.length===0)throw new Error("没有有效数据");let L=q;L.sort((k,D)=>{const P=new Date(k.date).getTime(),j=new Date(D.date).getTime();return P-j});const A=new Date;A.setDate(A.getDate()-i);const K=A.getTime();return L=L.filter(k=>new Date(k.date).getTime()>=K),L.length>T&&(L=L.slice(-T)),console.log(`[K线数据] 过滤后保留 ${L.length} 条数据（最近${i}天）`),L}catch(l){return console.error("[K线数据] 东方财富API失败:",l),rt(S,$,T)}}catch(E){console.error(`获取K线数据失败 (${S}, ${$}):`,E);const x=et($).count;return rt(S,$,x)}}async function rt(S,$,I){const O=et($),T=I??O.count,i=O.days;try{console.log(`[K线数据] 使用腾讯财经API（备用）获取 ${S} 的 ${$} 数据`);const s=ht(S);let R;$==="day"?R="day":$==="week"?R="week":$==="month"?R="month":R="day";const E=`https://web.ifzq.gtimg.cn/app/kline/kline?param=${s},${R},1,0,${T},640,qfq&_=${Date.now()}`;return console.log(`[K线数据] 腾讯财经API请求URL: ${E}`),new Promise(c=>{const x=document.createElement("script"),M=setTimeout(()=>{document.body.contains(x)&&document.body.removeChild(x),console.error("[K线数据] 腾讯财经API超时"),c([])},1e4);x.src=E,x.onload=()=>{clearTimeout(M),setTimeout(()=>{try{const B=`hq_str_${s}`,l=window[B];if(!l||typeof l!="string"){console.warn("[K线数据] 腾讯财经API：无法从全局变量获取数据"),c([]);return}console.log("[K线数据] 腾讯财经API返回数据（前200字符）:",l.substring(0,200));let f=l;const C=l.match(/var\s+hq_str_\w+="([^"]+)"/);C&&C[1]&&(f=C[1]);const L=f.split(";").filter(P=>P.trim()).slice(1),A=[];for(const P of L){if(!P.trim())continue;const j=P.split(",");if(j.length<6)continue;const _=j[0],Y=parseFloat(j[1]),Q=parseFloat(j[2]),U=parseFloat(j[3]),G=parseFloat(j[4]),H=parseFloat(j[5])||0;!isNaN(Y)&&!isNaN(Q)&&!isNaN(U)&&!isNaN(G)&&A.push({date:_,open:Y,high:U,low:G,close:Q,volume:H})}if(A.length===0){console.warn("[K线数据] 腾讯财经API：解析后没有有效数据"),c([]);return}console.log(`[K线数据] 腾讯财经API解析到 ${A.length} 条K线数据`);let K=A;K.sort((P,j)=>{const _=new Date(P.date).getTime(),Y=new Date(j.date).getTime();return _-Y});const k=new Date;k.setDate(k.getDate()-i);const D=k.getTime();K=K.filter(P=>new Date(P.date).getTime()>=D),K.length>T&&(K=K.slice(-T)),console.log(`[K线数据] 腾讯API过滤后保留 ${K.length} 条数据（最近${i}天）`),c(K)}catch(B){console.error("[K线数据] 腾讯财经API解析失败:",B),c([])}finally{document.body.contains(x)&&document.body.removeChild(x)}},100)},x.onerror=()=>{clearTimeout(M),document.body.contains(x)&&document.body.removeChild(x),console.error("[K线数据] 腾讯财经API加载失败"),c([])},document.body.appendChild(x)})}catch(s){return console.error("[K线数据] 腾讯财经API失败:",s),[]}}const Nt=({open:S,onClose:$,stockCode:I,stockName:O})=>{const T=w.useRef(null),i=w.useRef(null),s=w.useRef(null),R=w.useRef(null),E=w.useRef(null),c=w.useRef({high:null,low:null,avg:null}),x=w.useRef(null),M=w.useRef(new Map),B=w.useRef([]),[l,f]=w.useState("day"),[C,q]=w.useState(!1),[L,A]=w.useState(null),[K,k]=w.useState([]),[D,P]=w.useState(null),j=w.useRef(null),[_,Y]=w.useState(!1),Q=X.useCallback(async()=>{try{const d=I.replace(/^(sh|sz)/,""),r=await pt(d);k(r.map(g=>({id:g.id,time:g.time,quantity:g.quantity,price:g.price})))}catch{k([])}},[I]),U=X.useCallback(()=>{if(!s.current||!i.current||!_){c.current.high&&(s.current.removePriceLine(c.current.high),c.current.high=null),c.current.low&&(s.current.removePriceLine(c.current.low),c.current.low=null),c.current.avg&&(s.current.removePriceLine(c.current.avg),c.current.avg=null);return}const r=i.current.timeScale().getVisibleRange();if(!r||!r.from||!r.to)return;const g=B.current.filter(t=>{const n=typeof t.time=="string"?new Date(t.time).getTime():t.time,o=typeof r.from=="string"?new Date(r.from).getTime():r.from,a=typeof r.to=="string"?new Date(r.to).getTime():r.to;return n>=o&&n<=a});if(g.length===0)return;const F=Math.max(...g.map(t=>t.high)),b=Math.min(...g.map(t=>t.low)),e=g.reduce((t,n)=>t+(n.high+n.low)/2,0)/g.length;c.current.high&&s.current.removePriceLine(c.current.high),c.current.low&&s.current.removePriceLine(c.current.low),c.current.avg&&s.current.removePriceLine(c.current.avg);try{c.current.high=s.current.createPriceLine({price:F,color:"#000000",lineWidth:1,lineStyle:Z.Dashed,axisLabelVisible:!0,title:"最高价"}),c.current.low=s.current.createPriceLine({price:b,color:"#000000",lineWidth:1,lineStyle:Z.Dashed,axisLabelVisible:!0,title:"最低价"}),c.current.avg=s.current.createPriceLine({price:e,color:"#000000",lineWidth:1,lineStyle:Z.Dashed,axisLabelVisible:!0,title:"均价"})}catch{}},[_]),G=X.useCallback((d,r)=>{const g=new Map;return d.forEach(F=>{let b=F.time;b.includes(" ")&&(b=b.split(" ")[0]);const e=new Date(b+"T00:00:00");if(isNaN(e.getTime()))return;let t;if(r==="day"){const n=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");t=`${n}-${o}-${a}`}else if(r==="week"){const n=e.getDay(),o=n===0?-6:1-n,a=new Date(e);a.setDate(e.getDate()+o),a.setHours(0,0,0,0);const u=a.getFullYear(),y=String(a.getMonth()+1).padStart(2,"0"),v=String(a.getDate()).padStart(2,"0");t=`${u}-${y}-${v}`}else{const n=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0");t=`${n}-${o}`}g.has(t)||g.set(t,[]),g.get(t).push(F)}),g},[]),H=X.useCallback(async()=>{if(!(!i.current||!s.current)){q(!0),A(null);try{const d=await Pt(I,l);if(d.length===0){A("暂无数据，请检查网络连接或稍后重试"),q(!1);return}const r=d.map(e=>{let t=e.date;return t.includes("-")||t.length===8&&(t=`${t.substring(0,4)}-${t.substring(4,6)}-${t.substring(6,8)}`),{time:t,open:e.open,high:e.high,low:e.low,close:e.close}}).sort((e,t)=>{const n=typeof e.time=="string"?new Date(e.time).getTime():e.time,o=typeof t.time=="string"?new Date(t.time).getTime():t.time;return n-o});B.current=r;const g=G(K,l),F=[],b=new Map;r.forEach((e,t)=>{const n=typeof e.time=="string"?e.time:new Date(e.time).toISOString().split("T")[0],o=l==="day"?n:l==="week"?(()=>{const u=new Date(n+"T00:00:00"),y=u.getDay(),v=y===0?-6:1-y,p=new Date(u);return p.setDate(u.getDate()+v),p.setHours(0,0,0,0),`${p.getFullYear()}-${String(p.getMonth()+1).padStart(2,"0")}-${String(p.getDate()).padStart(2,"0")}`})():n.substring(0,7),a=g.get(o)||[];if(a.length>0){const u=a.reduce((y,v)=>y+v.quantity,0);b.set(n,a)}}),s.current&&i.current?(i.current.applyOptions({timeScale:{tickMarkFormatter:(e,t,n)=>{if(typeof e=="string"){const o=new Date(e);if(l==="day"){const a=String(o.getMonth()+1).padStart(2,"0"),u=String(o.getDate()).padStart(2,"0");return`${a}-${u}`}else if(l==="week"){const a=String(o.getMonth()+1).padStart(2,"0"),u=String(o.getDate()).padStart(2,"0");return`${a}-${u}`}else if(l==="month"){const a=o.getFullYear(),u=String(o.getMonth()+1).padStart(2,"0");return`${a}-${u}`}}return e}},localization:{dateFormat:l==="day"||l==="week"?"MM-dd":"yyyy-MM",timeFormatter:e=>{if(typeof e=="string"){const t=new Date(e);if(l==="day"){const n=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getDate()).padStart(2,"0");return`${n}-${o}`}else if(l==="week"){const n=t.getDay(),o=n===0?-6:1-n,a=new Date(t);a.setDate(t.getDate()+o),a.setHours(0,0,0,0);const u=new Date(a);u.setDate(a.getDate()+6);const y=String(a.getMonth()+1).padStart(2,"0"),v=String(a.getDate()).padStart(2,"0"),p=String(u.getMonth()+1).padStart(2,"0"),W=String(u.getDate()).padStart(2,"0");return`${y}-${v}～${p}-${W}`}else if(l==="month"){const n=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0");return`${n}-${o}`}}return e}}}),s.current.setData(r),R.current&&(R.current.remove(),R.current=null),i.current.timeScale().fitContent(),i.current._transactionMap=b,at(r,[],b),ot(K),i.current&&(i.current.timeScale().subscribeVisibleTimeRangeChange(()=>{U()}),setTimeout(()=>{U()},100))):A("图表初始化失败"),q(!1)}catch(d){A(`加载数据失败: ${d instanceof Error?d.message:"未知错误"}`),q(!1)}}},[I,l,K,G]),at=(d,r,g)=>{if(!i.current||!x.current||!s.current)return;M.current.forEach(o=>{o.parentNode&&o.parentNode.removeChild(o)}),M.current.clear();const F=i.current,b=x.current,e=F.timeScale(),t=s.current;d.forEach(o=>{const a=o.time,u=typeof a=="string"?a:new Date(a).toISOString().split("T")[0],y=g.get(u);if(!y||y.length===0)return;const p=y.reduce((N,J)=>N+J.quantity,0)>0,W=e.timeToCoordinate(a);if(W===null)return;let V=null;try{V=t.priceToCoordinate(o.high)}catch{return}if(V===null)return;const m=document.createElement("div");m.textContent=p?"买":"卖",m.style.position="absolute",m.style.left=`${W}px`,m.style.top=`${V-25}px`,m.style.transform="translateX(-50%)",m.style.backgroundColor=p?"#ef5350":"#26a69a",m.style.color="#ffffff",m.style.padding="2px 6px",m.style.borderRadius="4px",m.style.fontSize="12px",m.style.fontWeight="bold",m.style.whiteSpace="nowrap",m.style.pointerEvents="none",m.style.zIndex="10",m.style.boxShadow="0 1px 3px rgba(0,0,0,0.3)",m.style.display="inline-block",b.appendChild(m),M.current.set(String(a),m)});const n=()=>{d.forEach(o=>{const a=o.time,u=M.current.get(String(a));if(!u)return;const y=e.timeToCoordinate(a);if(y===null)return;let v=null;try{v=t.priceToCoordinate(o.high)}catch{return}v!==null&&(u.style.left=`${y}px`,u.style.top=`${v-25}px`)})};F.subscribeCrosshairMove(n),e.subscribeVisibleTimeRangeChange(n)},ot=d=>{if(!s.current)return;E.current&&(s.current.removePriceLine(E.current),E.current=null);const[r,g]=mt(d);if(r>0&&g>0)try{E.current=s.current.createPriceLine({price:g,color:"#0000FF",lineWidth:1,lineStyle:Z.Dashed,axisLabelVisible:!0,title:"持仓价"})}catch{}};w.useEffect(()=>{if(!S){R.current&&(R.current.remove(),R.current=null),M.current.forEach(r=>{r.parentNode&&r.parentNode.removeChild(r)}),M.current.clear(),i.current&&(i.current.remove(),i.current=null,s.current=null);return}const d=setTimeout(()=>{if(!T.current)return;const r=dt(T.current,{layout:{background:{type:ft.Solid,color:"white"},textColor:"#333"},width:T.current.clientWidth,height:500,grid:{vertLines:{color:"#e0e0e0"},horzLines:{color:"#e0e0e0"}},timeScale:{timeVisible:!0,secondsVisible:!1,rightOffset:12,barSpacing:3,fixLeftEdge:!0,lockVisibleTimeRangeOnResize:!0},rightPriceScale:{borderColor:"#e0e0e0"}});i.current=r;const g=r.addSeries(gt,{upColor:"#ef5350",downColor:"#26a69a",borderVisible:!1,wickUpColor:"#ef5350",wickDownColor:"#26a69a"});s.current=g,r.subscribeCrosshairMove(b=>{var a;if(!b.time||!b.point){P(null);return}const e=(a=i.current)==null?void 0:a._transactionMap;if(!e){P(null);return}const t=b.time;let n;if(typeof t=="string"?n=t:n=new Date(t).toISOString().split("T")[0],l!=="day")if(l==="week"){const u=new Date(n+"T00:00:00"),y=u.getDay(),v=y===0?-6:1-y,p=new Date(u);p.setDate(u.getDate()+v),p.setHours(0,0,0,0),`${p.getFullYear()}${String(p.getMonth()+1).padStart(2,"0")}${String(p.getDate()).padStart(2,"0")}`}else n.substring(0,7);const o=e.get(n)||[];if(o.length>0){if(!T.current){P(null);return}const u=T.current.getBoundingClientRect(),y=b.point.x+u.left,v=b.point.y+u.top;let p;if(l==="day"){const W=new Date(n),V=String(W.getMonth()+1).padStart(2,"0"),m=String(W.getDate()).padStart(2,"0");p=`${V}-${m}`}else if(l==="week"){const W=new Date(n+"T00:00:00"),V=W.getDay(),m=V===0?-6:1-V,N=new Date(W);N.setDate(W.getDate()+m),N.setHours(0,0,0,0);const J=new Date(N);J.setDate(N.getDate()+6);const st=String(N.getMonth()+1).padStart(2,"0"),ct=String(N.getDate()).padStart(2,"0"),lt=String(J.getMonth()+1).padStart(2,"0"),ut=String(J.getDate()).padStart(2,"0");p=`${st}-${ct}～${lt}-${ut}`}else p=n.substring(0,7);P({x:y+10,y:v-10,transactions:o,date:p})}else P(null)}),H();const F=()=>{T.current&&i.current&&i.current.applyOptions({width:T.current.clientWidth})};window.addEventListener("resize",F),i.current._cleanup=()=>{window.removeEventListener("resize",F),i.current&&(i.current.remove(),i.current=null),s.current=null},H()},100);return()=>{var r;clearTimeout(d),(r=i.current)!=null&&r._cleanup?i.current._cleanup():(i.current&&(i.current.remove(),i.current=null),s.current=null)}},[S,H,Q]),w.useEffect(()=>{S&&I&&Q()},[S,I,Q]),w.useEffect(()=>{if(!S||!i.current||!s.current)return;const d=setTimeout(()=>{H()},100);return()=>{clearTimeout(d)}},[l,S,H]);const it=(d,r)=>{r!==null&&f(r)};return h.jsxs(yt,{open:S,onClose:$,maxWidth:"lg",fullWidth:!0,children:[h.jsx(St,{sx:{pb:1},children:h.jsxs(z,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[h.jsxs(nt,{variant:"h6",children:[O," (",I,") - K线图"]}),h.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:2},children:[h.jsx(bt,{control:h.jsx($t,{checked:_,onChange:d=>{Y(d.target.checked),setTimeout(()=>{U()},0)},size:"small"}),label:"价格区间",sx:{mr:0}}),h.jsxs(Tt,{value:l,exclusive:!0,onChange:it,size:"small","aria-label":"K线周期",children:[h.jsx(tt,{value:"day","aria-label":"日K",children:"日K"}),h.jsx(tt,{value:"week","aria-label":"周K",children:"周K"}),h.jsx(tt,{value:"month","aria-label":"月K",children:"月K"})]})]})]})}),h.jsxs(wt,{sx:{pt:1,position:"relative"},children:[C&&h.jsx(z,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:10},children:h.jsx(kt,{})}),L&&h.jsx(z,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:10},children:h.jsx(nt,{color:"error",children:L})}),h.jsxs(z,{sx:{position:"relative",width:"100%",height:500,minHeight:500},children:[h.jsx(z,{ref:T,sx:{width:"100%",height:"100%"}}),h.jsx(z,{ref:x,sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:5}}),D&&h.jsxs(z,{ref:j,sx:{position:"fixed",left:`${D.x}px`,top:`${D.y}px`,background:"rgba(0, 0, 0, 0.8)",color:"white",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",pointerEvents:"none",zIndex:1e3,whiteSpace:"nowrap",boxShadow:"0 2px 8px rgba(0,0,0,0.3)"},children:[h.jsx(z,{sx:{marginBottom:"4px",fontWeight:"bold",borderBottom:"1px solid rgba(255,255,255,0.3)",paddingBottom:"4px"},children:D.date}),D.transactions.map((d,r)=>h.jsxs(z,{sx:{marginTop:"2px"},children:[d.quantity>0?"买":"卖"," ",d.price.toFixed(3),"*",Math.abs(d.quantity).toFixed(0)]},r))]})]})]}),h.jsx(xt,{sx:{px:2,pb:1.5},children:h.jsx(Dt,{size:"small",onClick:$,children:"关闭"})})]})};export{Nt as KlineChart};
