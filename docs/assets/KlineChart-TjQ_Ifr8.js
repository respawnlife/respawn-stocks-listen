import{r as D,R as Z,j as h,l as gt,m as ft,B,s as rt,y as ht,a8 as pt,a9 as mt,aa as et,n as yt,G as St,p as wt,q as xt}from"./react-mui-B8w-7gqd.js";import{h as tt,q as Dt,W as bt,R as $t}from"./charts--AwToQQJ.js";import{f as Tt,l as kt,c as vt}from"./index-DibxdAHg.js";import"./vendor-CTCyfRUx.js";function nt(x){switch(x){case"day":return{count:60,days:60};case"week":return{count:26,days:180};case"month":return{count:36,days:1095};default:return{count:60,days:60}}}async function Pt(x,T,A){var c,K;const _=nt(T),k=_.count,s=_.days;try{let E=x.replace(/^(sh|sz)/,""),l;x.startsWith("sh")?l=!0:x.startsWith("sz")?l=!1:l=!(E.startsWith("00")||E.startsWith("30"));const b=`${l?"1":"0"}.${E}`;let M;T==="day"?M="101":T==="week"?M="102":T==="month"?M="103":M="101";const q=`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${b}&fields1=f1,f2,f3,f4,f5,f6&fields2=f51,f52,f53,f54,f55,f56,f57,f58&klt=${M}&fqt=1&beg=0&end=20500000&lmt=${k}`;console.log(`[K线数据] 请求URL: ${q}`);try{const i=await fetch(q);if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const g=await i.json();console.log("[K线数据] API返回:",g),console.log("[K线数据] json.data:",g.data),console.log("[K线数据] json.data?.klines:",(c=g.data)==null?void 0:c.klines);let C=null;if((K=g.data)!=null&&K.klines&&Array.isArray(g.data.klines)?C=g.data.klines:g.klines&&Array.isArray(g.klines)?C=g.klines:Array.isArray(g.data)?C=g.data:g.rc===0&&g.data&&(console.log("[K线数据] 尝试查找其他数据字段:",Object.keys(g.data)),g.data.data&&Array.isArray(g.data.data)?C=g.data.data:g.data.list&&Array.isArray(g.data.list)&&(C=g.data.list)),!C||C.length===0)throw console.error("[K线数据] 无法找到有效数据，返回结构:",JSON.stringify(g,null,2)),new Error("没有有效数据");console.log(`[K线数据] 找到 ${C.length} 条K线数据`);const V=C.map(v=>{const $=v.split(",");return $.length<6?null:{date:$[0],open:parseFloat($[1])||0,close:parseFloat($[2])||0,high:parseFloat($[3])||0,low:parseFloat($[4])||0,volume:parseFloat($[5])||0}}).filter(v=>v!==null&&v.open>0&&v.close>0);if(V.length===0)throw new Error("没有有效数据");let F=V;F.sort((v,$)=>{const P=new Date(v.date).getTime(),L=new Date($.date).getTime();return P-L});const I=new Date;I.setDate(I.getDate()-s);const j=I.getTime();return F=F.filter(v=>new Date(v.date).getTime()>=j),F.length>k&&(F=F.slice(-k)),console.log(`[K线数据] 过滤后保留 ${F.length} 条数据（最近${s}天）`),F}catch(i){return console.error("[K线数据] 东方财富API失败:",i),at(x,T,k)}}catch(E){console.error(`获取K线数据失败 (${x}, ${T}):`,E);const b=nt(T).count;return at(x,T,b)}}async function at(x,T,A){const _=nt(T),k=A??_.count,s=_.days;try{console.log(`[K线数据] 使用腾讯财经API（备用）获取 ${x} 的 ${T} 数据`);const c=Tt(x);let K;T==="day"?K="day":T==="week"?K="week":T==="month"?K="month":K="day";const E=`https://web.ifzq.gtimg.cn/app/kline/kline?param=${c},${K},1,0,${k},640,qfq&_=${Date.now()}`;return console.log(`[K线数据] 腾讯财经API请求URL: ${E}`),new Promise(l=>{const b=document.createElement("script"),M=setTimeout(()=>{document.body.contains(b)&&document.body.removeChild(b),console.error("[K线数据] 腾讯财经API超时"),l([])},1e4);b.src=E,b.onload=()=>{clearTimeout(M),setTimeout(()=>{try{const q=`hq_str_${c}`,i=window[q];if(!i||typeof i!="string"){console.warn("[K线数据] 腾讯财经API：无法从全局变量获取数据"),l([]);return}console.log("[K线数据] 腾讯财经API返回数据（前200字符）:",i.substring(0,200));let g=i;const C=i.match(/var\s+hq_str_\w+="([^"]+)"/);C&&C[1]&&(g=C[1]);const F=g.split(";").filter(P=>P.trim()).slice(1),I=[];for(const P of F){if(!P.trim())continue;const L=P.split(",");if(L.length<6)continue;const H=L[0],Q=parseFloat(L[1]),z=parseFloat(L[2]),U=parseFloat(L[3]),G=parseFloat(L[4]),X=parseFloat(L[5])||0;!isNaN(Q)&&!isNaN(z)&&!isNaN(U)&&!isNaN(G)&&I.push({date:H,open:Q,high:U,low:G,close:z,volume:X})}if(I.length===0){console.warn("[K线数据] 腾讯财经API：解析后没有有效数据"),l([]);return}console.log(`[K线数据] 腾讯财经API解析到 ${I.length} 条K线数据`);let j=I;j.sort((P,L)=>{const H=new Date(P.date).getTime(),Q=new Date(L.date).getTime();return H-Q});const v=new Date;v.setDate(v.getDate()-s);const $=v.getTime();j=j.filter(P=>new Date(P.date).getTime()>=$),j.length>k&&(j=j.slice(-k)),console.log(`[K线数据] 腾讯API过滤后保留 ${j.length} 条数据（最近${s}天）`),l(j)}catch(q){console.error("[K线数据] 腾讯财经API解析失败:",q),l([])}finally{document.body.contains(b)&&document.body.removeChild(b)}},100)},b.onerror=()=>{clearTimeout(M),document.body.contains(b)&&document.body.removeChild(b),console.error("[K线数据] 腾讯财经API加载失败"),l([])},document.body.appendChild(b)})}catch(c){return console.error("[K线数据] 腾讯财经API失败:",c),[]}}const jt=({open:x,onClose:T,stockCode:A,stockName:_})=>{const k=D.useRef(null),s=D.useRef(null),c=D.useRef(null),K=D.useRef(null),E=D.useRef(null),l=D.useRef({high:null,low:null,avg:null}),b=D.useRef(null),M=D.useRef(new Map),q=D.useRef([]),[i,g]=D.useState("day"),[C,V]=D.useState(!1),[F,I]=D.useState(null),[j,v]=D.useState([]),[$,P]=D.useState(null),L=D.useRef(null),[H,Q]=D.useState(!1),z=D.useRef(null),U=Z.useCallback(async()=>{try{const u=A.replace(/^(sh|sz)/,""),o=await kt(u);v(o.map(p=>({id:p.id,time:p.time,quantity:p.quantity,price:p.price})))}catch{v([])}},[A]),G=Z.useCallback(u=>{const o=u!==void 0?u:H;if(!c.current||!s.current||!o){l.current.high&&(c.current.removePriceLine(l.current.high),l.current.high=null),l.current.low&&(c.current.removePriceLine(l.current.low),l.current.low=null),l.current.avg&&(c.current.removePriceLine(l.current.avg),l.current.avg=null);return}const m=s.current.timeScale().getVisibleRange();if(!m||!m.from||!m.to)return;const f=q.current.filter(t=>{const n=typeof t.time=="string"?new Date(t.time).getTime():t.time,d=typeof m.from=="string"?new Date(m.from).getTime():m.from,y=typeof m.to=="string"?new Date(m.to).getTime():m.to;return n>=d&&n<=y});if(f.length===0)return;const e=Math.max(...f.map(t=>t.high)),r=Math.min(...f.map(t=>t.low)),a=f.reduce((t,n)=>t+(n.high+n.low)/2,0)/f.length;l.current.high&&c.current.removePriceLine(l.current.high),l.current.low&&c.current.removePriceLine(l.current.low),l.current.avg&&c.current.removePriceLine(l.current.avg);try{l.current.high=c.current.createPriceLine({price:e,color:"#000000",lineWidth:1,lineStyle:tt.Dashed,axisLabelVisible:!0,title:"最高价"}),l.current.low=c.current.createPriceLine({price:r,color:"#000000",lineWidth:1,lineStyle:tt.Dashed,axisLabelVisible:!0,title:"最低价"}),l.current.avg=c.current.createPriceLine({price:a,color:"#000000",lineWidth:1,lineStyle:tt.Dashed,axisLabelVisible:!0,title:"均价"})}catch{}},[H]),X=Z.useCallback((u,o)=>{const p=new Map;return u.forEach(m=>{let f=m.time;f.includes(" ")&&(f=f.split(" ")[0]);const e=new Date(f+"T00:00:00");if(isNaN(e.getTime()))return;let r;if(o==="day"){const a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");r=`${a}-${t}-${n}`}else if(o==="week"){const a=e.getDay(),t=a===0?-6:1-a,n=new Date(e);n.setDate(e.getDate()+t),n.setHours(0,0,0,0);const d=n.getFullYear(),y=String(n.getMonth()+1).padStart(2,"0"),R=String(n.getDate()).padStart(2,"0");r=`${d}-${y}-${R}`}else{const a=e.getFullYear(),t=String(e.getMonth()+1).padStart(2,"0");r=`${a}-${t}`}p.has(r)||p.set(r,[]),p.get(r).push(m)}),p},[]),Y=Z.useCallback(async()=>{if(!(!s.current||!c.current)){V(!0),I(null);try{const u=await Pt(A,i);if(u.length===0){I("暂无数据，请检查网络连接或稍后重试"),V(!1);return}const o=u.map(e=>{let r=e.date;return r.includes("-")||r.length===8&&(r=`${r.substring(0,4)}-${r.substring(4,6)}-${r.substring(6,8)}`),{time:r,open:e.open,high:e.high,low:e.low,close:e.close}}).sort((e,r)=>{const a=typeof e.time=="string"?new Date(e.time).getTime():e.time,t=typeof r.time=="string"?new Date(r.time).getTime():r.time;return a-t});q.current=o;const p=X(j,i),m=[],f=new Map;o.forEach((e,r)=>{const a=typeof e.time=="string"?e.time:new Date(e.time).toISOString().split("T")[0],t=i==="day"?a:i==="week"?(()=>{const d=new Date(a+"T00:00:00"),y=d.getDay(),R=y===0?-6:1-y,S=new Date(d);return S.setDate(d.getDate()+R),S.setHours(0,0,0,0),`${S.getFullYear()}-${String(S.getMonth()+1).padStart(2,"0")}-${String(S.getDate()).padStart(2,"0")}`})():a.substring(0,7),n=p.get(t)||[];if(n.length>0){const d=n.reduce((y,R)=>y+R.quantity,0);f.set(a,n)}}),c.current&&s.current?(s.current.applyOptions({timeScale:{tickMarkFormatter:(e,r,a)=>{if(typeof e=="string"){const t=new Date(e);if(i==="day"){const n=String(t.getMonth()+1).padStart(2,"0"),d=String(t.getDate()).padStart(2,"0");return`${n}-${d}`}else if(i==="week"){const n=String(t.getMonth()+1).padStart(2,"0"),d=String(t.getDate()).padStart(2,"0");return`${n}-${d}`}else if(i==="month"){const n=t.getFullYear(),d=String(t.getMonth()+1).padStart(2,"0");return`${n}-${d}`}}return e}},localization:{dateFormat:i==="day"||i==="week"?"MM-dd":"yyyy-MM",timeFormatter:e=>{if(typeof e=="string"){const r=new Date(e);if(i==="day"){const a=String(r.getMonth()+1).padStart(2,"0"),t=String(r.getDate()).padStart(2,"0");return`${a}-${t}`}else if(i==="week"){const a=r.getDay(),t=a===0?-6:1-a,n=new Date(r);n.setDate(r.getDate()+t),n.setHours(0,0,0,0);const d=new Date(n);d.setDate(n.getDate()+6);const y=String(n.getMonth()+1).padStart(2,"0"),R=String(n.getDate()).padStart(2,"0"),S=String(d.getMonth()+1).padStart(2,"0"),W=String(d.getDate()).padStart(2,"0");return`${y}-${R}～${S}-${W}`}else if(i==="month"){const a=r.getFullYear(),t=String(r.getMonth()+1).padStart(2,"0");return`${a}-${t}`}}return e}}}),c.current.setData(o),K.current&&(K.current.remove(),K.current=null),s.current.timeScale().fitContent(),s.current._transactionMap=f,ot(o,[],f),st(j),s.current&&(s.current.timeScale().subscribeVisibleTimeRangeChange(()=>{G()}),setTimeout(()=>{G()},100))):I("图表初始化失败"),V(!1)}catch(u){I(`加载数据失败: ${u instanceof Error?u.message:"未知错误"}`),V(!1)}}},[A,i,j,X]),ot=(u,o,p)=>{if(!s.current||!b.current||!c.current)return;M.current.forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)}),M.current.clear();const m=s.current,f=b.current,e=m.timeScale(),r=c.current;u.forEach(t=>{const n=t.time,d=typeof n=="string"?n:new Date(n).toISOString().split("T")[0],y=p.get(d);if(!y||y.length===0)return;const S=y.reduce((N,J)=>N+J.quantity,0)>0,W=e.timeToCoordinate(n);if(W===null)return;let O=null;try{O=r.priceToCoordinate(t.high)}catch{return}if(O===null)return;const w=document.createElement("div");w.textContent=S?"买":"卖",w.style.position="absolute",w.style.left=`${W}px`,w.style.top=`${O-25}px`,w.style.transform="translateX(-50%)",w.style.backgroundColor=S?"#ef5350":"#26a69a",w.style.color="#ffffff",w.style.padding="2px 6px",w.style.borderRadius="4px",w.style.fontSize="12px",w.style.fontWeight="bold",w.style.whiteSpace="nowrap",w.style.pointerEvents="none",w.style.zIndex="10",w.style.boxShadow="0 1px 3px rgba(0,0,0,0.3)",w.style.display="inline-block",f.appendChild(w),M.current.set(String(n),w)});const a=()=>{u.forEach(t=>{const n=t.time,d=M.current.get(String(n));if(!d)return;const y=e.timeToCoordinate(n);if(y===null)return;let R=null;try{R=r.priceToCoordinate(t.high)}catch{return}R!==null&&(d.style.left=`${y}px`,d.style.top=`${R-25}px`)})};m.subscribeCrosshairMove(a),e.subscribeVisibleTimeRangeChange(a)},st=u=>{if(!c.current)return;E.current&&(c.current.removePriceLine(E.current),E.current=null);const[o,p]=vt(u);if(o>0&&p>0)try{E.current=c.current.createPriceLine({price:p,color:"#0000FF",lineWidth:1,lineStyle:tt.Dashed,axisLabelVisible:!0,title:"持仓价"})}catch{}};D.useEffect(()=>{if(!x){K.current&&(K.current.remove(),K.current=null),M.current.forEach(o=>{o.parentNode&&o.parentNode.removeChild(o)}),M.current.clear(),s.current&&(s.current.remove(),s.current=null,c.current=null);return}const u=setTimeout(()=>{if(!k.current)return;const o=Dt(k.current,{layout:{background:{type:bt.Solid,color:"white"},textColor:"#333"},width:k.current.clientWidth,height:500,grid:{vertLines:{color:"#e0e0e0"},horzLines:{color:"#e0e0e0"}},timeScale:{timeVisible:!0,secondsVisible:!1,rightOffset:12,barSpacing:3,fixLeftEdge:!0,lockVisibleTimeRangeOnResize:!0},rightPriceScale:{borderColor:"#e0e0e0"}});s.current=o;const p=o.addSeries($t,{upColor:"#ef5350",downColor:"#26a69a",borderVisible:!1,wickUpColor:"#ef5350",wickDownColor:"#26a69a"});c.current=p,o.subscribeCrosshairMove(f=>{var n;if(!f.time||!f.point){P(null);return}const e=(n=s.current)==null?void 0:n._transactionMap;if(!e){P(null);return}const r=f.time;let a;if(typeof r=="string"?a=r:a=new Date(r).toISOString().split("T")[0],i!=="day")if(i==="week"){const d=new Date(a+"T00:00:00"),y=d.getDay(),R=y===0?-6:1-y,S=new Date(d);S.setDate(d.getDate()+R),S.setHours(0,0,0,0),`${S.getFullYear()}${String(S.getMonth()+1).padStart(2,"0")}${String(S.getDate()).padStart(2,"0")}`}else a.substring(0,7);const t=e.get(a)||[];if(t.length>0){if(!k.current){P(null);return}const d=k.current.getBoundingClientRect(),y=f.point.x+d.left,R=f.point.y+d.top;let S;if(i==="day"){const W=new Date(a),O=String(W.getMonth()+1).padStart(2,"0"),w=String(W.getDate()).padStart(2,"0");S=`${O}-${w}`}else if(i==="week"){const W=new Date(a+"T00:00:00"),O=W.getDay(),w=O===0?-6:1-O,N=new Date(W);N.setDate(W.getDate()+w),N.setHours(0,0,0,0);const J=new Date(N);J.setDate(N.getDate()+6);const ct=String(N.getMonth()+1).padStart(2,"0"),lt=String(N.getDate()).padStart(2,"0"),ut=String(J.getMonth()+1).padStart(2,"0"),dt=String(J.getDate()).padStart(2,"0");S=`${ct}-${lt}～${ut}-${dt}`}else S=a.substring(0,7);P({x:y+10,y:R-10,transactions:t,date:S})}else P(null)}),Y();const m=()=>{k.current&&s.current&&s.current.applyOptions({width:k.current.clientWidth})};window.addEventListener("resize",m),s.current._cleanup=()=>{window.removeEventListener("resize",m),s.current&&(s.current.remove(),s.current=null),c.current=null},Y()},100);return()=>{var o;clearTimeout(u),(o=s.current)!=null&&o._cleanup?s.current._cleanup():(s.current&&(s.current.remove(),s.current=null),c.current=null)}},[x,Y,U]),D.useEffect(()=>{x&&A&&U()},[x,A,U]),D.useEffect(()=>{if(!x||!s.current||!c.current)return;const u=setTimeout(()=>{Y()},100);return()=>{clearTimeout(u)}},[i,x,Y]),D.useEffect(()=>{if(!x){z.current&&(clearInterval(z.current),z.current=null);return}const u=5*60*1e3,o=async()=>{const p=new Date,m=p.getHours(),f=p.getMinutes(),e=`${m.toString().padStart(2,"0")}:${f.toString().padStart(2,"0")}`,r=p.getDay();if(r===0||r===6)return;const a=e>="09:30"&&e<="11:30",t=e>="13:00"&&e<="15:00";if(!(!a&&!t))try{console.log(`[K线自动刷新] ${new Date().toLocaleTimeString()} 开始刷新 ${A} 的 ${i} K线数据`),await Y(),console.log(`[K线自动刷新] ${new Date().toLocaleTimeString()} 完成刷新 ${A} 的 ${i} K线数据`)}catch(n){console.error("[K线自动刷新] 刷新失败:",n)}};return o(),z.current=setInterval(o,u),()=>{z.current&&(clearInterval(z.current),z.current=null)}},[x,A,i,Y]);const it=(u,o)=>{o!==null&&g(o)};return h.jsxs(gt,{open:x,onClose:T,maxWidth:"lg",fullWidth:!0,children:[h.jsx(ft,{sx:{pb:.5},children:h.jsxs(B,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[h.jsxs(rt,{variant:"h6",children:[_," (",A,") - K线图"]}),h.jsxs(B,{sx:{display:"flex",alignItems:"center",gap:2},children:[h.jsx(ht,{control:h.jsx(pt,{checked:H,onChange:u=>{const o=u.target.checked;Q(o),G(o)},size:"small"}),label:"价格区间",sx:{mr:0}}),h.jsxs(mt,{value:i,exclusive:!0,onChange:it,size:"small","aria-label":"K线周期",children:[h.jsx(et,{value:"day","aria-label":"日K",children:"日K"}),h.jsx(et,{value:"week","aria-label":"周K",children:"周K"}),h.jsx(et,{value:"month","aria-label":"月K",children:"月K"})]})]})]})}),h.jsxs(yt,{sx:{pt:.5,position:"relative"},children:[C&&h.jsx(B,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:10},children:h.jsx(St,{})}),F&&h.jsx(B,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:10},children:h.jsx(rt,{color:"error",children:F})}),h.jsxs(B,{sx:{position:"relative",width:"100%",height:500,minHeight:500},children:[h.jsx(B,{ref:k,sx:{width:"100%",height:"100%"}}),h.jsx(B,{ref:b,sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:5}}),$&&h.jsxs(B,{ref:L,sx:{position:"fixed",left:`${$.x}px`,top:`${$.y}px`,background:"rgba(0, 0, 0, 0.8)",color:"white",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",pointerEvents:"none",zIndex:1e3,whiteSpace:"nowrap",boxShadow:"0 2px 8px rgba(0,0,0,0.3)"},children:[h.jsx(B,{sx:{marginBottom:"4px",fontWeight:"bold",borderBottom:"1px solid rgba(255,255,255,0.3)",paddingBottom:"4px"},children:$.date}),$.transactions.map((u,o)=>h.jsxs(B,{sx:{marginTop:"2px"},children:[u.quantity>0?"买":"卖"," ",u.price.toFixed(3),"*",Math.abs(u.quantity).toFixed(0)]},o))]})]})]}),h.jsx(wt,{sx:{px:1,pb:.5},children:h.jsx(xt,{size:"small",onClick:T,children:"关闭"})})]})};export{jt as KlineChart};
