import{r as D,R as X,j as f,i as dt,k as gt,B as z,p as nt,t as ft,Z as ht,_ as pt,$ as tt,l as mt,w as yt,n as wt,o as St}from"./react-mui-GIrKQtIc.js";import{h as Z,q as xt,W as Dt,R as bt}from"./charts-DLsYqWXl.js";import{f as $t,l as Tt,c as kt}from"./index-Cg-YF-GT.js";import"./vendor-ST8YoCxk.js";function et(S){switch(S){case"day":return{count:60,days:60};case"week":return{count:26,days:180};case"month":return{count:36,days:1095};default:return{count:60,days:60}}}async function Pt(S,T,I){var i,M;const O=et(T),k=O.count,o=O.days;try{let A=S.replace(/^(sh|sz)/,""),c;S.startsWith("sh")?c=!0:S.startsWith("sz")?c=!1:c=!(A.startsWith("00")||A.startsWith("30"));const b=`${c?"1":"0"}.${A}`;let C;T==="day"?C="101":T==="week"?C="102":T==="month"?C="103":C="101";const B=`https://push2his.eastmoney.com/api/qt/stock/kline/get?secid=${b}&fields1=f1,f2,f3,f4,f5,f6&fields2=f51,f52,f53,f54,f55,f56,f57,f58&klt=${C}&fqt=1&beg=0&end=20500000&lmt=${k}`;console.log(`[K线数据] 请求URL: ${B}`);try{const l=await fetch(B);if(!l.ok)throw new Error(`HTTP error! status: ${l.status}`);const g=await l.json();console.log("[K线数据] API返回:",g),console.log("[K线数据] json.data:",g.data),console.log("[K线数据] json.data?.klines:",(i=g.data)==null?void 0:i.klines);let K=null;if((M=g.data)!=null&&M.klines&&Array.isArray(g.data.klines)?K=g.data.klines:g.klines&&Array.isArray(g.klines)?K=g.klines:Array.isArray(g.data)?K=g.data:g.rc===0&&g.data&&(console.log("[K线数据] 尝试查找其他数据字段:",Object.keys(g.data)),g.data.data&&Array.isArray(g.data.data)?K=g.data.data:g.data.list&&Array.isArray(g.data.list)&&(K=g.data.list)),!K||K.length===0)throw console.error("[K线数据] 无法找到有效数据，返回结构:",JSON.stringify(g,null,2)),new Error("没有有效数据");console.log(`[K线数据] 找到 ${K.length} 条K线数据`);const V=K.map(P=>{const $=P.split(",");return $.length<6?null:{date:$[0],open:parseFloat($[1])||0,close:parseFloat($[2])||0,high:parseFloat($[3])||0,low:parseFloat($[4])||0,volume:parseFloat($[5])||0}}).filter(P=>P!==null&&P.open>0&&P.close>0);if(V.length===0)throw new Error("没有有效数据");let E=V;E.sort((P,$)=>{const v=new Date(P.date).getTime(),L=new Date($.date).getTime();return v-L});const F=new Date;F.setDate(F.getDate()-o);const j=F.getTime();return E=E.filter(P=>new Date(P.date).getTime()>=j),E.length>k&&(E=E.slice(-k)),console.log(`[K线数据] 过滤后保留 ${E.length} 条数据（最近${o}天）`),E}catch(l){return console.error("[K线数据] 东方财富API失败:",l),rt(S,T,k)}}catch(A){console.error(`获取K线数据失败 (${S}, ${T}):`,A);const b=et(T).count;return rt(S,T,b)}}async function rt(S,T,I){const O=et(T),k=I??O.count,o=O.days;try{console.log(`[K线数据] 使用腾讯财经API（备用）获取 ${S} 的 ${T} 数据`);const i=$t(S);let M;T==="day"?M="day":T==="week"?M="week":T==="month"?M="month":M="day";const A=`https://web.ifzq.gtimg.cn/app/kline/kline?param=${i},${M},1,0,${k},640,qfq&_=${Date.now()}`;return console.log(`[K线数据] 腾讯财经API请求URL: ${A}`),new Promise(c=>{const b=document.createElement("script"),C=setTimeout(()=>{document.body.contains(b)&&document.body.removeChild(b),console.error("[K线数据] 腾讯财经API超时"),c([])},1e4);b.src=A,b.onload=()=>{clearTimeout(C),setTimeout(()=>{try{const B=`hq_str_${i}`,l=window[B];if(!l||typeof l!="string"){console.warn("[K线数据] 腾讯财经API：无法从全局变量获取数据"),c([]);return}console.log("[K线数据] 腾讯财经API返回数据（前200字符）:",l.substring(0,200));let g=l;const K=l.match(/var\s+hq_str_\w+="([^"]+)"/);K&&K[1]&&(g=K[1]);const E=g.split(";").filter(v=>v.trim()).slice(1),F=[];for(const v of E){if(!v.trim())continue;const L=v.split(",");if(L.length<6)continue;const _=L[0],Y=parseFloat(L[1]),Q=parseFloat(L[2]),U=parseFloat(L[3]),G=parseFloat(L[4]),H=parseFloat(L[5])||0;!isNaN(Y)&&!isNaN(Q)&&!isNaN(U)&&!isNaN(G)&&F.push({date:_,open:Y,high:U,low:G,close:Q,volume:H})}if(F.length===0){console.warn("[K线数据] 腾讯财经API：解析后没有有效数据"),c([]);return}console.log(`[K线数据] 腾讯财经API解析到 ${F.length} 条K线数据`);let j=F;j.sort((v,L)=>{const _=new Date(v.date).getTime(),Y=new Date(L.date).getTime();return _-Y});const P=new Date;P.setDate(P.getDate()-o);const $=P.getTime();j=j.filter(v=>new Date(v.date).getTime()>=$),j.length>k&&(j=j.slice(-k)),console.log(`[K线数据] 腾讯API过滤后保留 ${j.length} 条数据（最近${o}天）`),c(j)}catch(B){console.error("[K线数据] 腾讯财经API解析失败:",B),c([])}finally{document.body.contains(b)&&document.body.removeChild(b)}},100)},b.onerror=()=>{clearTimeout(C),document.body.contains(b)&&document.body.removeChild(b),console.error("[K线数据] 腾讯财经API加载失败"),c([])},document.body.appendChild(b)})}catch(i){return console.error("[K线数据] 腾讯财经API失败:",i),[]}}const Kt=({open:S,onClose:T,stockCode:I,stockName:O})=>{const k=D.useRef(null),o=D.useRef(null),i=D.useRef(null),M=D.useRef(null),A=D.useRef(null),c=D.useRef({high:null,low:null,avg:null}),b=D.useRef(null),C=D.useRef(new Map),B=D.useRef([]),[l,g]=D.useState("day"),[K,V]=D.useState(!1),[E,F]=D.useState(null),[j,P]=D.useState([]),[$,v]=D.useState(null),L=D.useRef(null),[_,Y]=D.useState(!1),Q=X.useCallback(async()=>{try{const d=I.replace(/^(sh|sz)/,""),s=await Tt(d);P(s.map(x=>({id:x.id,time:x.time,quantity:x.quantity,price:x.price})))}catch{P([])}},[I]),U=X.useCallback(d=>{const s=d!==void 0?d:_;if(!i.current||!o.current||!s){c.current.high&&(i.current.removePriceLine(c.current.high),c.current.high=null),c.current.low&&(i.current.removePriceLine(c.current.low),c.current.low=null),c.current.avg&&(i.current.removePriceLine(c.current.avg),c.current.avg=null);return}const w=o.current.timeScale().getVisibleRange();if(!w||!w.from||!w.to)return;const h=B.current.filter(t=>{const e=typeof t.time=="string"?new Date(t.time).getTime():t.time,u=typeof w.from=="string"?new Date(w.from).getTime():w.from,p=typeof w.to=="string"?new Date(w.to).getTime():w.to;return e>=u&&e<=p});if(h.length===0)return;const n=Math.max(...h.map(t=>t.high)),r=Math.min(...h.map(t=>t.low)),a=h.reduce((t,e)=>t+(e.high+e.low)/2,0)/h.length;c.current.high&&i.current.removePriceLine(c.current.high),c.current.low&&i.current.removePriceLine(c.current.low),c.current.avg&&i.current.removePriceLine(c.current.avg);try{c.current.high=i.current.createPriceLine({price:n,color:"#000000",lineWidth:1,lineStyle:Z.Dashed,axisLabelVisible:!0,title:"最高价"}),c.current.low=i.current.createPriceLine({price:r,color:"#000000",lineWidth:1,lineStyle:Z.Dashed,axisLabelVisible:!0,title:"最低价"}),c.current.avg=i.current.createPriceLine({price:a,color:"#000000",lineWidth:1,lineStyle:Z.Dashed,axisLabelVisible:!0,title:"均价"})}catch{}},[_]),G=X.useCallback((d,s)=>{const x=new Map;return d.forEach(w=>{let h=w.time;h.includes(" ")&&(h=h.split(" ")[0]);const n=new Date(h+"T00:00:00");if(isNaN(n.getTime()))return;let r;if(s==="day"){const a=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0"),e=String(n.getDate()).padStart(2,"0");r=`${a}-${t}-${e}`}else if(s==="week"){const a=n.getDay(),t=a===0?-6:1-a,e=new Date(n);e.setDate(n.getDate()+t),e.setHours(0,0,0,0);const u=e.getFullYear(),p=String(e.getMonth()+1).padStart(2,"0"),R=String(e.getDate()).padStart(2,"0");r=`${u}-${p}-${R}`}else{const a=n.getFullYear(),t=String(n.getMonth()+1).padStart(2,"0");r=`${a}-${t}`}x.has(r)||x.set(r,[]),x.get(r).push(w)}),x},[]),H=X.useCallback(async()=>{if(!(!o.current||!i.current)){V(!0),F(null);try{const d=await Pt(I,l);if(d.length===0){F("暂无数据，请检查网络连接或稍后重试"),V(!1);return}const s=d.map(n=>{let r=n.date;return r.includes("-")||r.length===8&&(r=`${r.substring(0,4)}-${r.substring(4,6)}-${r.substring(6,8)}`),{time:r,open:n.open,high:n.high,low:n.low,close:n.close}}).sort((n,r)=>{const a=typeof n.time=="string"?new Date(n.time).getTime():n.time,t=typeof r.time=="string"?new Date(r.time).getTime():r.time;return a-t});B.current=s;const x=G(j,l),w=[],h=new Map;s.forEach((n,r)=>{const a=typeof n.time=="string"?n.time:new Date(n.time).toISOString().split("T")[0],t=l==="day"?a:l==="week"?(()=>{const u=new Date(a+"T00:00:00"),p=u.getDay(),R=p===0?-6:1-p,m=new Date(u);return m.setDate(u.getDate()+R),m.setHours(0,0,0,0),`${m.getFullYear()}-${String(m.getMonth()+1).padStart(2,"0")}-${String(m.getDate()).padStart(2,"0")}`})():a.substring(0,7),e=x.get(t)||[];if(e.length>0){const u=e.reduce((p,R)=>p+R.quantity,0);h.set(a,e)}}),i.current&&o.current?(o.current.applyOptions({timeScale:{tickMarkFormatter:(n,r,a)=>{if(typeof n=="string"){const t=new Date(n);if(l==="day"){const e=String(t.getMonth()+1).padStart(2,"0"),u=String(t.getDate()).padStart(2,"0");return`${e}-${u}`}else if(l==="week"){const e=String(t.getMonth()+1).padStart(2,"0"),u=String(t.getDate()).padStart(2,"0");return`${e}-${u}`}else if(l==="month"){const e=t.getFullYear(),u=String(t.getMonth()+1).padStart(2,"0");return`${e}-${u}`}}return n}},localization:{dateFormat:l==="day"||l==="week"?"MM-dd":"yyyy-MM",timeFormatter:n=>{if(typeof n=="string"){const r=new Date(n);if(l==="day"){const a=String(r.getMonth()+1).padStart(2,"0"),t=String(r.getDate()).padStart(2,"0");return`${a}-${t}`}else if(l==="week"){const a=r.getDay(),t=a===0?-6:1-a,e=new Date(r);e.setDate(r.getDate()+t),e.setHours(0,0,0,0);const u=new Date(e);u.setDate(e.getDate()+6);const p=String(e.getMonth()+1).padStart(2,"0"),R=String(e.getDate()).padStart(2,"0"),m=String(u.getMonth()+1).padStart(2,"0"),W=String(u.getDate()).padStart(2,"0");return`${p}-${R}～${m}-${W}`}else if(l==="month"){const a=r.getFullYear(),t=String(r.getMonth()+1).padStart(2,"0");return`${a}-${t}`}}return n}}}),i.current.setData(s),M.current&&(M.current.remove(),M.current=null),o.current.timeScale().fitContent(),o.current._transactionMap=h,at(s,[],h),ot(j),o.current&&(o.current.timeScale().subscribeVisibleTimeRangeChange(()=>{U()}),setTimeout(()=>{U()},100))):F("图表初始化失败"),V(!1)}catch(d){F(`加载数据失败: ${d instanceof Error?d.message:"未知错误"}`),V(!1)}}},[I,l,j,G]),at=(d,s,x)=>{if(!o.current||!b.current||!i.current)return;C.current.forEach(t=>{t.parentNode&&t.parentNode.removeChild(t)}),C.current.clear();const w=o.current,h=b.current,n=w.timeScale(),r=i.current;d.forEach(t=>{const e=t.time,u=typeof e=="string"?e:new Date(e).toISOString().split("T")[0],p=x.get(u);if(!p||p.length===0)return;const m=p.reduce((N,J)=>N+J.quantity,0)>0,W=n.timeToCoordinate(e);if(W===null)return;let q=null;try{q=r.priceToCoordinate(t.high)}catch{return}if(q===null)return;const y=document.createElement("div");y.textContent=m?"买":"卖",y.style.position="absolute",y.style.left=`${W}px`,y.style.top=`${q-25}px`,y.style.transform="translateX(-50%)",y.style.backgroundColor=m?"#ef5350":"#26a69a",y.style.color="#ffffff",y.style.padding="2px 6px",y.style.borderRadius="4px",y.style.fontSize="12px",y.style.fontWeight="bold",y.style.whiteSpace="nowrap",y.style.pointerEvents="none",y.style.zIndex="10",y.style.boxShadow="0 1px 3px rgba(0,0,0,0.3)",y.style.display="inline-block",h.appendChild(y),C.current.set(String(e),y)});const a=()=>{d.forEach(t=>{const e=t.time,u=C.current.get(String(e));if(!u)return;const p=n.timeToCoordinate(e);if(p===null)return;let R=null;try{R=r.priceToCoordinate(t.high)}catch{return}R!==null&&(u.style.left=`${p}px`,u.style.top=`${R-25}px`)})};w.subscribeCrosshairMove(a),n.subscribeVisibleTimeRangeChange(a)},ot=d=>{if(!i.current)return;A.current&&(i.current.removePriceLine(A.current),A.current=null);const[s,x]=kt(d);if(s>0&&x>0)try{A.current=i.current.createPriceLine({price:x,color:"#0000FF",lineWidth:1,lineStyle:Z.Dashed,axisLabelVisible:!0,title:"持仓价"})}catch{}};D.useEffect(()=>{if(!S){M.current&&(M.current.remove(),M.current=null),C.current.forEach(s=>{s.parentNode&&s.parentNode.removeChild(s)}),C.current.clear(),o.current&&(o.current.remove(),o.current=null,i.current=null);return}const d=setTimeout(()=>{if(!k.current)return;const s=xt(k.current,{layout:{background:{type:Dt.Solid,color:"white"},textColor:"#333"},width:k.current.clientWidth,height:500,grid:{vertLines:{color:"#e0e0e0"},horzLines:{color:"#e0e0e0"}},timeScale:{timeVisible:!0,secondsVisible:!1,rightOffset:12,barSpacing:3,fixLeftEdge:!0,lockVisibleTimeRangeOnResize:!0},rightPriceScale:{borderColor:"#e0e0e0"}});o.current=s;const x=s.addSeries(bt,{upColor:"#ef5350",downColor:"#26a69a",borderVisible:!1,wickUpColor:"#ef5350",wickDownColor:"#26a69a"});i.current=x,s.subscribeCrosshairMove(h=>{var e;if(!h.time||!h.point){v(null);return}const n=(e=o.current)==null?void 0:e._transactionMap;if(!n){v(null);return}const r=h.time;let a;if(typeof r=="string"?a=r:a=new Date(r).toISOString().split("T")[0],l!=="day")if(l==="week"){const u=new Date(a+"T00:00:00"),p=u.getDay(),R=p===0?-6:1-p,m=new Date(u);m.setDate(u.getDate()+R),m.setHours(0,0,0,0),`${m.getFullYear()}${String(m.getMonth()+1).padStart(2,"0")}${String(m.getDate()).padStart(2,"0")}`}else a.substring(0,7);const t=n.get(a)||[];if(t.length>0){if(!k.current){v(null);return}const u=k.current.getBoundingClientRect(),p=h.point.x+u.left,R=h.point.y+u.top;let m;if(l==="day"){const W=new Date(a),q=String(W.getMonth()+1).padStart(2,"0"),y=String(W.getDate()).padStart(2,"0");m=`${q}-${y}`}else if(l==="week"){const W=new Date(a+"T00:00:00"),q=W.getDay(),y=q===0?-6:1-q,N=new Date(W);N.setDate(W.getDate()+y),N.setHours(0,0,0,0);const J=new Date(N);J.setDate(N.getDate()+6);const it=String(N.getMonth()+1).padStart(2,"0"),ct=String(N.getDate()).padStart(2,"0"),lt=String(J.getMonth()+1).padStart(2,"0"),ut=String(J.getDate()).padStart(2,"0");m=`${it}-${ct}～${lt}-${ut}`}else m=a.substring(0,7);v({x:p+10,y:R-10,transactions:t,date:m})}else v(null)}),H();const w=()=>{k.current&&o.current&&o.current.applyOptions({width:k.current.clientWidth})};window.addEventListener("resize",w),o.current._cleanup=()=>{window.removeEventListener("resize",w),o.current&&(o.current.remove(),o.current=null),i.current=null},H()},100);return()=>{var s;clearTimeout(d),(s=o.current)!=null&&s._cleanup?o.current._cleanup():(o.current&&(o.current.remove(),o.current=null),i.current=null)}},[S,H,Q]),D.useEffect(()=>{S&&I&&Q()},[S,I,Q]),D.useEffect(()=>{if(!S||!o.current||!i.current)return;const d=setTimeout(()=>{H()},100);return()=>{clearTimeout(d)}},[l,S,H]);const st=(d,s)=>{s!==null&&g(s)};return f.jsxs(dt,{open:S,onClose:T,maxWidth:"lg",fullWidth:!0,children:[f.jsx(gt,{sx:{pb:.5},children:f.jsxs(z,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[f.jsxs(nt,{variant:"h6",children:[O," (",I,") - K线图"]}),f.jsxs(z,{sx:{display:"flex",alignItems:"center",gap:2},children:[f.jsx(ft,{control:f.jsx(ht,{checked:_,onChange:d=>{const s=d.target.checked;Y(s),U(s)},size:"small"}),label:"价格区间",sx:{mr:0}}),f.jsxs(pt,{value:l,exclusive:!0,onChange:st,size:"small","aria-label":"K线周期",children:[f.jsx(tt,{value:"day","aria-label":"日K",children:"日K"}),f.jsx(tt,{value:"week","aria-label":"周K",children:"周K"}),f.jsx(tt,{value:"month","aria-label":"月K",children:"月K"})]})]})]})}),f.jsxs(mt,{sx:{pt:.5,position:"relative"},children:[K&&f.jsx(z,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:10},children:f.jsx(yt,{})}),E&&f.jsx(z,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:10},children:f.jsx(nt,{color:"error",children:E})}),f.jsxs(z,{sx:{position:"relative",width:"100%",height:500,minHeight:500},children:[f.jsx(z,{ref:k,sx:{width:"100%",height:"100%"}}),f.jsx(z,{ref:b,sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",pointerEvents:"none",zIndex:5}}),$&&f.jsxs(z,{ref:L,sx:{position:"fixed",left:`${$.x}px`,top:`${$.y}px`,background:"rgba(0, 0, 0, 0.8)",color:"white",padding:"8px 12px",borderRadius:"4px",fontSize:"12px",pointerEvents:"none",zIndex:1e3,whiteSpace:"nowrap",boxShadow:"0 2px 8px rgba(0,0,0,0.3)"},children:[f.jsx(z,{sx:{marginBottom:"4px",fontWeight:"bold",borderBottom:"1px solid rgba(255,255,255,0.3)",paddingBottom:"4px"},children:$.date}),$.transactions.map((d,s)=>f.jsxs(z,{sx:{marginTop:"2px"},children:[d.quantity>0?"买":"卖"," ",d.price.toFixed(3),"*",Math.abs(d.quantity).toFixed(0)]},s))]})]})]}),f.jsx(wt,{sx:{px:1,pb:.5},children:f.jsx(St,{size:"small",onClick:T,children:"关闭"})})]})};export{Kt as KlineChart};
